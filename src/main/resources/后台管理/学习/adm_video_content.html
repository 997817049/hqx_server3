<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <title>电视管理</title>
    <link rel="stylesheet" type="text/css" href="../public/layui/css/layui.css">
    <link type="text/css" rel="stylesheet" href="../public/css/common.css">
    <link rel="stylesheet" type="text/css" href="../public/css/nav.css">
    <link rel="stylesheet" type="text/css" href="../public/css/iconfont.css">
    <link rel="stylesheet" type="text/css" href="../public/css/add.css">
    <link rel="stylesheet" type="text/css" href="../public/webuploader/webuploader.css">
    <script src="../public/js/public.js"></script>
    <script src="../public/js/jquery-3.2.1.min.js"></script>
    <script src="../public/layui/layui.js"></script>
    <script src="../public/js/alert.js"></script>
    <script type="text/javascript" src="../public/js/nav.js"></script>
    <script src="../public/js/echarts.min.js"></script>
    <script type="text/javascript" src="../public/webuploader/webuploader.js"></script>
</head>

<body>
<!-- 头部导航 -->
<div class="jzy_w_max jzy_h_50 br_12">
    <!-- LOGO -->
    <div class="jzy_w_50 jzy_h_50 br_12 br_11_hove lt logo">
        <a href=""><img src="../public/images/aliyun.png"></a>
    </div>
    <!--菜单1-->
    <div class="jzy_w_90 jzy_h_50 br_12 br_11_hove lt top-txt">
        <a class="cr_h_0 fs_14" href="">管理控制台</a>
    </div>

    <!--头像-->
    <div class="jzy_w_50 jzy_h_50 br_12 br_11_hove rt top-txt logo">
        <img class="jzy_boy_18" src="../public/images/touxiang.jpg" width="36" height="36">
        <!-- 头像下拉菜单 -->
        <div class="jzy_w_270 jzy_h_408 br_h_0 top_nav">
            <!--头像跟用户名-->
            <div class="jzy_w_max jzy_h_50 lt" style="margin-top: 15px"><img class="jzy_boy_18"
                                                                             src="../public/images/touxiang.jpg"
                                                                             width="36" height="36"></div>
            <div class="jzy_w_max jzy_h_30 lt" style="line-height: 30px; border-bottom: 1px solid #e2e2e2">
                1731223728@qq.com
            </div>
            <!--用户公共操作权限-->
            <div class="jzy_w_250 jzy_h_250 lt" style="padding: 10px">
                <div class="jzy_w_80 jzy_h_80 lt br_h_2_hove">
                    <a><p class="jzy_h_30"><img src="../public/images/icon/jbzl.png"></p>基本资料</a>
                </div>

                <div class="jzy_w_80 jzy_h_80 lt br_h_2_hove">
                    <a><p class="jzy_h_30"><img src="../public/images/icon/smrz.png"></p>实名认证</a>
                </div>

                <div class="jzy_w_80 jzy_h_80 lt br_h_2_hove">
                    <a><p class="jzy_h_30"><img src="../public/images/icon/aqsz.png"></p>安全设置</a>
                </div>

                <div class="jzy_w_80 jzy_h_80 lt br_h_2_hove">
                    <a><p class="jzy_h_30"><img src="../public/images/icon/fxgk.png"></p>风险管控</a>
                </div>

                <div class="jzy_w_80 jzy_h_80 lt br_h_2_hove">
                    <a><p class="jzy_h_30"><img src="../public/images/icon/fwkz.png"></p>访问控制</a>
                </div>

                <div class="jzy_w_80 jzy_h_80 lt br_h_2_hove">
                    <a><p class="jzy_h_30"><img src="../public/images/icon/api.png"></p>API接口</a>
                </div>

                <div class="jzy_w_80 jzy_h_80 lt br_h_2_hove">
                    <a><p class="jzy_h_30"><img src="../public/images/icon/hyqy.png"></p>会员权益</a>
                </div>

                <div class="jzy_w_80 jzy_h_80 lt br_h_2_hove">
                    <a><p class="jzy_h_30"><img src="../public/images/icon/hyjf.png"></p>会员积分</a>
                </div>

                <div class="jzy_w_80 jzy_h_80 lt br_h_2_hove">
                    <a><p class="jzy_h_30"><img src="../public/images/icon/wjgl.png"></p>文件管理</a>
                </div>
            </div>
            <!--退出登录-->
            <div class="jzy_w_max jzy_h_42 lt br_h_9" style="background: #f5f5f6; line-height: 45px"><a
                    href="../login.html">退出管理控制台</a></div>
        </div>
    </div>

    <!--菜单2-->
    <div class="jzy_w_90 jzy_h_50 br_12 br_11_hove rt top-txt">
        <a class="cr_h_0 fs_14">语言选择</a>
        <!-- 头像下拉菜单 -->
        <div class="jzy_w_90 br_h_0 top_nav nav2">
            <p class="p"><a href="">简体中文</a></p>
            <p class="p"><a href="">English</a></p>
        </div>
    </div>

    <!--菜单3-->
    <div class="jzy_w_90 jzy_h_50 br_12 br_11_hove rt top-txt">
        <a class="cr_h_0 fs_14">权限设置</a>
        <!-- 头像下拉菜单 -->
        <div class="jzy_w_90 br_h_0 top_nav nav2">
            <p class="p"><a href="">新建权限</a></p>
            <p class="p"><a href="">角色列表</a></p>
            <p class="p"><a href="">部门管理</a></p>
        </div>
    </div>

</div>

<!--左侧主导航-->
<div class="jzy_w_180 lt main_height main_left nav" style="background: #333744">

    <div class="nav-top">
        <div id="mini" style="background: #4a5064; text-align: center"><img src="../public/images/icon/suofang.png" width="20"></div>
    </div>
    <ul>
        <li class="nav-item">
            <a href="javascript:"><i class="my-icon nav-icon icon_1"></i><span>新闻模块</span><i
                    class="my-icon nav-more"></i></a>
            <ul>
                <li><a href="../新闻/adm_news.html"><span>新闻</span></a></li>
                <li><a href="../新闻/adm_character.html"><span>人物</span></a></li>
                <li><a href="../新闻/adm_military.html"><span>军事</span></a></li>
                <li><a href="../新闻/adm_history.html"><span>史实</span></a></li>
            </ul>
        </li>
        <li class="nav-item">
            <a href="javascript:"><i class="my-icon nav-icon icon_1"></i><span>基地模块</span><i
                    class="my-icon nav-more"></i></a>
            <ul>
                <li><a href="../基地/base_add.html"><span>新增景点</span></a></li>
                <li><a href="../基地/adm_base.html"><span>查看景点</span></a></li>
            </ul>
        </li>
        <li class="nav-item">
            <a href="javascript:"><i class="my-icon nav-icon icon_1"></i><span>学习模块</span><i
                    class="my-icon nav-more"></i></a>
            <ul>
                <li><a href="../学习/adm_exam.html"><span>答题</span></a></li>
                <li><a href="../学习/adm_book.html"><span>书籍</span></a></li>
                <li><a href="../学习/adm_teleplay.html"><span>电视</span></a></li>
                <li><a href="../tmp/adm_film.html"><span>电影</span></a></li>
                <li><a href="../学习/adm_variety.html"><span>综艺</span></a></li>
                <li><a href="../学习/adm_documentary.html"><span>纪录片</span></a></li>
                <li><a href="../学习/adm_drama.html"><span>歌舞剧</span></a></li>
            </ul>
        </li>
    </ul>
</div>

<!--左侧次导航-->
<div class="jzy_w_180 lt main_height main_nav" style="background: #D9DEE4">
    <div class="jzy_w_150 jzy_h_70 fs_13 lt" style="font-weight: bold; line-height: 70px;padding-left: 30px">学习管理</div>
    <div class="jzy_w_180 fs_13 lt main_height2" style="background: #EAEDF1;">
        <div class="jzy_w_130 jzy_h_40 fs_12 lt br_h_0" style="line-height: 40px;padding-left: 50px"><a
                href="">视频内容列表</a></div>
    </div>
</div>

<!--主内容框架-->
<div class="main_height main_index lt" style="background: #f2f4f8;">
    <div class="layui-btn-group demoTable jzy_w_max br_h_0 tabTop">
        <span>视频内容列表</span>
    </div>

    <div class="tree_left" style="width: 100%">
        <div class="layui-form">
            <div id="video_content" style="display: none">
                <!--名称-->
                <div class="layui-form-item" style="margin-top: 20px; width: 90%">
                    <label class="layui-form-label">名称</label>
                    <div class="layui-input-block">
                        <input id="title" type="text" name="title" placeholder="请输入标题" class="layui-input">
                    </div>
                </div>
                <!--集数-->
                <div class="layui-form-item" style="width: 90%">
                    <label class="layui-form-label">集数</label>
                    <div class="layui-input-block">
                        <input id="num" type="text" name="title" placeholder="请输入集数" class="layui-input">
                    </div>
                </div>
                <!--上传图片-->
                <div class="layui-form-item" style="width: 90%">
                    <label class="layui-form-label">视频</label>
                    <div class="layui-input-block">
                        <!--视频预览-->
                        <div id="file-box" style="width: 300px; height: 200px;"></div>
                        <!--上传视频-->
                        <div class="layui-input-inline" style="margin-top: 10px;">
                            <div id="picker" style="display: inline-block;float:left">选择文件</div>
                        </div>
                    </div>
                </div>
                <!--消息-->
                <div id="info-wrapper" class="layui-form-item" style="width: 90%">
                    <div class="layui-input-block" style="line-height: 36px; ">
                        <!--消息-->
                        <div id="info" style="font-size: 14px;font-weight: bold;color: red;"></div>
                    </div>
                </div>
                <!--按钮-->
                <div class="layui-form-item" style="width: 90%">
                    <div class="layui-input-block" style="float: right;">
                        <button id="confirm" class="layui-btn layui-btn-normal" onclick="dealConfirm()">确认</button>
                        <button id="reset" class="layui-btn layui-btn-normal" onclick="dealCancel()">取消</button>
                    </div>
                </div>
            </div>
            <table id="demo" lay-filter="demo" style="width: 90%"></table>
        </div>
    </div>
</div>
</body>

<script type="text/html" id="titleBar">
    <div class="layui-btn-group">
        <button type="button" class="layui-btn layui-btn-sm" lay-event="delete">
            <i class="layui-icon">&#xe640;</i><!--删除-->
        </button>
        <button type="button" class="layui-btn layui-btn-sm" lay-event="edit">
            <i class="layui-icon">&#xe642;</i><!--编辑-->
        </button>
        <button type="button" class="layui-btn layui-btn-sm" lay-event="add">
            <i class="layui-icon">&#xe654;</i><!--添加-->
        </button>
    </div>
</script>

<script>
    var r = /^\+?[1-9][0-9]*$/;//检查是否为数字
    para = new Array();
    num = 0;
    videoUrl = null;
    isFileChoose = false;

    layui.use(['form', 'table', 'laydate', 'tree'], function () {
        table = layui.table;
        form = layui.form;

        init();
    });

    function init() {
        var query = window.location.search.substring(1);
        query = decodeURI(query);
        query = query.split("&");
        for(var i = 0; i < query.length; i++) {
            var tmp = query[i].split("=");
            para[tmp[0]] = tmp[1];
        }
        para["model"] = JSON.parse(para["model"]);

        //初始化table
        initTable();
        //初始化webuploader
        initUpLoader();

        $("#title").val(para["model"].title);
        document.getElementById("title").disabled = "true";

        //获取分类
        $.ajax({
            type: "POST",
            url: serverIp + "classify/study", // 后端服务器上传地址
            data: {
                part: para["part"]
            },
            success: function (rs) {
                rs = rs.data;
                $("#label").empty();
                $("#label").html('<option value="">请选择</option>');
                for(var i = 0; i < rs.length; i++) {
                    $("#label").append('<option value="' + rs[i].num + '">' + rs[i].msg + '</option>');//将列表中的内容加入到第二个下拉框
                }
                form.render("select");
            },
            error: function (returndata) {
            }
        });
    }

    function dealConfirm() {
        $("#info").show();
        var num = $("#num").val();
        if (!r.test(num) || num < 0 || num > para["model"].num){
            $("#info").html("num不正确");
            return;
        }

        $("#info").hide();
        console.log("isFileChoose:" + isFileChoose);
        if(isFileChoose){
            console.log("上传视频");
            uploader.upload();
        } else {
            console.log("更新num");
            updateVideo();
        }
    }

    function updateVideo() {
        $.ajax({
            type: "POST",
            url: serverIp + "update/study/video/content", // 后端服务器上传地址
            data: {
                part:para["part"],
                id: para["model"].id,
                oldNum:num,
                newNum: $("#num").val(),
                videoUrl: videoUrl
            },
            success:function (rs) {
                layer.msg("更新成功");
                $("#video_content").hide();
                $('#file-box').html('');
                $("#file-box").hide();
                $("#num").val('');
                loadVideoContent();
            },
            error:function () {
                layer.msg("更新失败，请稍后再试");
            }
        });
    }

    function dealCancel() {
        $('#file-box').html('');
        $("#file-box").hide();
        $("#num").val('');
        $("#video_content").hide();
    }

    function deleteVideo(checkStatus) {
        var checkList = checkStatus.data;
        if (checkList.length <= 0) {
            layer.alert("至少要选择一行记录");
            return;
        }
        var idList = [];
        for (var i = 0; i < checkList.length; i++) {
            idList.push(checkList[i].num);
        }

        $.ajax({
            type: "POST",
            url: serverIp + "delete/study/video", // 后端服务器上传地址
            data: {
                part: para["part"],
                id: para["model"].id,
                list: JSON.stringify(idList)
            },
            success: function (rs) {
                layer.msg("已删除");
                //重新渲染
                var page = $(".layui-laypage-em").next().html();
                table.reload('demo', {
                    page: {curr: page}
                });
            },
            error: function () {
                layer.msg("删除失败");
            }
        })
    }

    function initTable() {
        // 开启一个数据表格
        table.render({
            elem: '#demo'
            , toolbar: '#titleBar' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
            , page: true //开启分页
            , limit: 10 //默认分页条数
            , height: 531 //高度最大化
            , cols: [
                [ //表头
                    {type: 'checkbox'} // 开启多选框
                    , {field: 'num', title: '集数', width: '12%', align: 'center', sort: true}
                    , {field: 'videoUrl', title: '视频路径', width: '30%'}
                ]
            ]
        });

        //头工具栏事件 查询删除
        table.on('toolbar(demo)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            switch (obj.event) {
                case 'delete':deleteVideo(checkStatus);break;
                case 'edit':
                    var checkList = checkStatus.data;
                    if (checkList.length <= 0 || checkList.length > 1) {
                        layer.alert("必须要选择一行记录");
                        return;
                    }
                    var model = checkList[0];
                    $("#num").val(model.num);
                    num = model.num;
                    videoUrl = model.videoUrl;
                    isFileChoose = false;
                    var dom = '<video id="video" width="300px" height="200px" controls="controls" autoplay="autoplay" src=' + (nginxIp + model.videoUrl) + '></video>';
                    $("#file-box").show();
                    $('#file-box').html(dom);
                    $("#video_content").show();
                    break;
                case 'add':
                    num = 0;
                    videoUrl = null;
                    isFileChoose = false;
                    $("#num").val('');
                    $('#file-box').html('');
                    $("#file-box").hide();
                    $("#video_content").show();
                    break;
                case 'LAYTABLE_PRINT':
                    //todo 有问题
                    layer.msg("该控件暂时无法使用");
                    break;
            }
        });

        loadVideoContent();
    }

    function initUpLoader() {
        WebUploader.Uploader.register({
            'before-send-file': 'beforeSendFile' //整个文件上传前
        }, {beforeSendFile: function( file ) {
                var that = this;
                var deferred = WebUploader.Deferred();
                //上传前请求服务端,判断文件是否已经上传过
                $.post(serverIp + "test/video", { md5: file.wholeMd5 },
                    function(rs){
                        if (rs.num == '0') {
                            console.log("文件已存在");
                            //跳过如果存在则跳过
                            that.owner.skipFile(file);
                            videoUrl = rs.data;
                            // OnProgRess();//设置进度条
                            updateVideo();
                        }
                        // 继续后面行为
                        deferred.resolve();
                    });
                return deferred.promise();
            }
        });

        uploader = WebUploader.create({
            auto: false,//设置选完文件后是否自动上传
            swf: 'static/webuploader/Uploader.swf',//swf文件路径
            server: serverIp + 'upload/video',// 文件接收服务端。
            // 选择文件的按钮。可选。
            // 内部根据当前运行是创建，可能是input元素，也可能是flash.
            pick: {
                id:'#picker',
                multiple:false,
            },
            chunkSize: 50 * 1024 * 1024,
            fileSizeLimit: 3000 * 1024 * 1024,//最大3GB
            fileSingleSizeLimit: 3000 * 1024 * 1024,
            //选择文件类型
            accept: {
                title: 'Video',
                extensions: 'mp4,avi',
                mimeTypes: 'video/*'
            }
        });

        //文件加入队列以前
        uploader.on('beforeFileQueued', function () {
            var fileList = uploader.getFiles();
            if (fileList.length > 0) {
                uploader.reset();
            }
            return true;
        });
        //文件加入队列时
        uploader.on('fileQueued', function (file) {
            isFileChoose = true;
            $('#file-box').html('');
            $("#file-box").hide();
            $("#info").show();
            $("#info").html("视频文件正在md5校验中，请稍后...");
            document.getElementById("confirm").disabled = "true";
            file.chunks = Math.ceil(file.size / (50 * 1024 * 1024));
            //进行md5校验
            uploader.md5File(file).progress(function (percentage) {//进度处理
                console.log('Percentage:', percentage);
            }).then(function (fileMd5) {
                file.wholeMd5 = fileMd5;//获取到了md5
                $("#info").html("视频文件校验完成");
                document.getElementById("confirm").disabled = "";
            });
        });

        //文件块发送前填充数据
        uploader.on('uploadBeforeSend', function (block, data) {
            // block为分块数据。file为分块对应的file对象。
            var file = block.file;
            console.log("一个文件块发送前" + file.name);
            // 将存在file对象中的md5数据携带发送过去。
            data.name = file.name;
            data.num = $("#num").val();//视频是哪一集的
            data.md5value = file.wholeMd5;//md5
            data.chunks = block.chunks;//块数
            data.chunk = block.chunk;//当前块编号
        });
        //上传成功
        uploader.on('uploadSuccess', function (file, response) {
            if(response === undefined) return;
            if(response.num === 1) {
                console.log("文件发送失败" + response);
                return;
            }
            console.log("文件发送成功 video返回值" + response.data);
            videoUrl = response.data;
            $("#info").html(file.name + "上传成功");
            OnProgRess();//设置进度条
            updateVideo();
        });
        //上传出错
        uploader.on('uploadError', function (file) {
            console.log("上传出错");
            $("#info").html(file.name + "上传出错");
        });
        //上传完成后回调
        uploader.on('uploadComplete', function (file) {
            //上传完删除进度条
            console.log("发送完成");
        });
    }

    function loadVideoContent() {
        $.ajax({
            type: "POST",
            url: serverIp + "study/video/content", // 后端服务器上传地址
            data: {
                userId:2,
                part:para["part"],
                id:para["model"].id
            },
            success: function (rs) {
                if (rs.num === 1) {
                    layer.msg("获取数据失败");
                    return;
                }
                table.reload('demo', {
                    data: rs.data
                });
            },
            error: function () {
                layer.msg("获取数据失败");
            }
        });
    }
</script>
</html>
